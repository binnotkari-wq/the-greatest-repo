# COmmandes utilisées lors de l'install de NixOS avec Gemini

Système installé directement avec flakes, fichier sde config préétablis.


```bash
btrfs subvolume create /mnt/@
sudo mount /dev/nvme0n1p3 /mnt
sudo btrfs subvolume create /mnt/@
sudo btrfs subvolume create /mnt/@home # A voir avec Gemini, si on a déjà une partition btrfs, et qu'on veut conserver home, il faurdait dans ce cas juste créer les sousvolumes dont on a besoin, supprimer ceux qui sont inutiles. On vidrait le contenu de tous les sousvolumes existants sauf home. A détailler avec Gemini.
sudo btrfs subvolume create /mnt/@nix
sudo btrfs subvolume create /mnt/@var # pas besoin si on fait un tmpfs sur / avec persistence selective (voir fiche Impersistance maximale)
sudo umount /mnt
export OPTS="noatime,compress=zstd,ssd,discard=async"
sudo mount -o subvol=@,$OPTS /dev/nvme0n1p3 /mnt
sudo mkdir -p /mnt/{home,nix,var,boot}
sudo mount -o subvol=@home,$OPTS /dev/nvme0n1p3 /mnt/home
sudo mount -o subvol=@nix,$OPTS /dev/nvme0n1p3 /mnt/nix
sudo mount -o subvol=@var,$OPTS /dev/nvme0n1p3 /mnt/var # pas besoin si on fait un tmpfs sur / avec persistence selective (voir fiche Impersistance maximale)
sudo mount /dev/nvme0n1p1 /mnt/boot
sudo nixos-generate-config --root /mnt  # meme si on va importer les fichiers du git, hardware-config.nix peut changer selon la plateforme matérielle. Donc il vaut mieux en générer un.
# Ensuite, on remplace le hardware-config.nix du git par celui qu'on vient de générer.
# Donc on se connecte à github, on pull le git, on le met dans /mnt/etc/nixos/ et on garde le hardware-configuration.nix qui a été généré, et qui va remplacer le hardware-configuration de github

# Un fois que les .nix sont en place dans /mnt/etc/nixos/ on lance l'installation de NixOS
cd /mnt/etc/nixos
sudo nixos-install --flake .#dell_5485 # adapter selon le nom de la machine choisi dans les flakes

=============================
# Si il y a un message d'erreur avec flake.lock : 

# 1. on supprime le flake.lock existant
sudo rm -f /mnt/etc/nixos/flake.lock

# 2. on le régenère
# sudo nix --extra-experimental-features "nix-command flakes" flake lock --store /mnt

# 3. on recommence un build
# sudo nixos-install --flake .#dell_5485
=============================


# Ensuite, il va demander le mot de passe root, enregistrer celui qu'on veut.


# Pour créer à la volée un mot de passe utilisateur : 
# sudo nixos-enter --root /mnt -c "passwd benoit" 
# inutile quand le hash du password est deja dans users.nix (ce qui permet l'impersistance)

# Rebooter.
# Ensuite après reboot, rapatrier les .nix dans /home/benoit/nixos-config/ et les supprimer de /etc/nixos/
# Il y aura de toute façon une phase post install pour synchoriser github, installer les flatpaks.
```